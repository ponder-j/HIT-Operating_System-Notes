# ⏱️ 操作系统第9章：调度 (Scheduling)

## 🌟 核心逻辑：谁先上？

调度的核心就是**排队论**。

- **目标**：
  - **对用户**：响应快（点一下马上有反应）。
  - **对系统**：吞吐量大（单位时间干完的活多），CPU 别闲着。
- **矛盾**：想响应快，就得频繁切换（轮转），但这会增加开销；想吞吐量大，就得减少切换，但这会让短任务等很久。

## 第一部分：调度的三个层次 (Types of Scheduling)

*对应课件 Page 5-7*

OS 在不同阶段有三道关卡来筛选进程：

1. **长程调度 (Long-Term Scheduling)**：
   - **关卡**：**New -> Ready**。
   - **任务**：决定**谁能进门**。控制**多道程序的度 (Degree of Multiprogramming)**。如果猛放人进来，系统会崩。
2. **中程调度 (Medium-Term Scheduling)**：
   - **关卡**：**Swapping (换入换出)**。
   - **任务**：内存不够时，把进程踢到硬盘（挂起）；内存够了，捞回来。
3. **短程调度 (Short-Term Scheduling) / 分派器 (Dispatcher)**：**本章重点**
   - **关卡**：**Ready -> Running**。
   - **任务**：决定**下一秒谁用 CPU**。频率极高（毫秒级）。

## 第二部分：调度算法 (Scheduling Algorithms) 🔥🔥🔥 计算题必考

*对应课件 Page 14-48*

这是这一章的灵魂。考试通常会给你一个表格（Arrival Time, Service Time），让你画甘特图，算平均周转时间。

### 1. 核心分类：抢占 vs 非抢占

- **非抢占 (Non-preemptive)**：一旦把 CPU 给了你，除非你自己运行完了或者去做 I/O 了，否则谁也别想把你赶下来。（霸道）
- **抢占 (Preemptive)**：虽然你正在爽，但如果来了个更重要的（或者你的时间片到了），OS 强行把你赶下来。（公平/灵活）

### 2. 六大算法详解

#### A. 先来先服务 (FCFS - First Come First Served)

- **规则**：排队买票，谁先来谁先上。**非抢占**。
- **缺点**：**护航效应 (Convoy Effect)**。如果前面有个长作业（大胖子），后面一堆短作业（小瘦子）都得等死。平均等待时间很长。

#### B. 轮转 (RR - Round Robin)

- **规则**：每人玩 $q$ 秒（时间片 Time Quantum），没玩完也得下去重新排队。**抢占**。
- **关键点**：$q$ 的大小。
  - $q$ 太大 $\to$ 退化成 FCFS。
  - $q$ 太小 $\to$ 频繁切换，CPU 都在做 Context Switch，没空干活。
- **适用**：分时系统（注重响应时间）。

#### C. 最短进程优先 (SPN - Shortest Process Next)

- **规则**：谁需要的服务时间 ($T_s$) 短，谁先上。**非抢占**。
- **优点**：平均周转时间通常是最短的。
- **缺点**：**饥饿 (Starvation)**。长作业可能永远抢不到 CPU。且需要**预测**进程还要跑多久（很难准）。

#### D. 最短剩余时间 (SRT - Shortest Remaining Time)

- **规则**：SPN 的**抢占版**。
- **逻辑**：只要新来的进程比你**剩下**的时间还短，你就得立马让位。
- **优点**：比 SPN 还要快。
- **缺点**：频繁抢占，开销大；长作业依然会饥饿。

#### E. 最高响应比优先 (HRRN - Highest Response Ratio Next)

- **规则**：为了解决 SPN 的饥饿问题，引入了**等待时间**。
- **公式**：$R = \frac{w + s}{s}$ （$w$=等待时间，$s$=服务时间）。
  - 分子里的 $w$ 越大（等得越久），$R$ 越大，优先级越高。
  - **老实人（长作业）等久了也能翻身**。**非抢占**。

#### F. 反馈 (Feedback)

- **规则**：多级队列。
  - 新来的进最高优先级队列（时间片短）。
  - 如果在时间片内没跑完，说明你是 CPU 密集型，**降级**到下一级队列。
  - 越往下，优先级越低，但给的时间片越长。
- **优点**：不用预测服务时间，自动识别长短作业。

## 第三部分：评价指标 (Scheduling Criteria)

*对应课件 Page 12*

做计算题时，最后要算这几个数：

1. **周转时间 (Turnaround Time,** $T_r$**)**：
   - $T_r =$ 完成时间 (Finish Time) $-$ 到达时间 (Arrival Time)
   - *含义：你把作业交给老师到老师改完发给你，总共过了多久。*
2. **归一化周转时间 (Normalized Turnaround Time,** $T_r / T_s$**)**：
   - $T_r / T_s =$ 周转时间 / 服务时间
   - *含义：如果你只要跑 1 分钟，却等了 10 分钟，这个比值是 10（很惨）。如果你要跑 100 分钟，等了 10 分钟，比值是 1.1（还行）。这个指标反映了**相对延迟**。*

## 📝 必背英文术语表 (Exam Vocabulary)

| **英文**                        | **中文**       | **含义**             |
| ------------------------------- | -------------- | -------------------- |
| **Short-Term Scheduling**       | 短程调度       | 决定谁获得CPU        |
| **Preemptive**                  | 抢占式         | 可被强行打断         |
| **Non-preemptive**              | 非抢占式       | 自己主动放弃         |
| **FCFS**                        | 先来先服务     | 简单，有护航效应     |
| **Round Robin (RR)**            | 轮转           | 时间片，公平         |
| **Time Quantum / Slice**        | 时间片         | RR的核心参数         |
| **SPN**                         | 最短进程优先   | 需预测，长作业饥饿   |
| **SRT**                         | 最短剩余时间   | 抢占版SPN            |
| **HRRN**                        | 最高响应比优先 | 解决饥饿，(w+s)/s    |
| **Response Time**               | 响应时间       | 提交到第一次产生输出 |
| **Turnaround Time (**$T_r$**)** | 周转时间       | 完成 - 到达          |
| **Throughput**                  | 吞吐量         | 单位时间完成的进程数 |

## 💡 计算题解题模版 (Cheat Sheet)

假设有以下进程：

A (到达 0, 服务 3), B (到达 2, 服务 6), C (到达 4, 服务 4)

**如果是 SRT (抢占式最短剩余时间):**

1. **Time 0**: A 到达。A 跑。
2. **Time 2**: B 到达。
   - A 剩 1，B 需要 6。
   - $1 < 6$，A 继续跑。
3. **Time 3**: A 完成。
   - 此时 B (需 6) 在等。
   - B 开始跑。
4. **Time 4**: C 到达。
   - 此时 B 刚跑了 1 秒，还剩 5。C 需要 4。
   - $4 < 5$，**抢占！** B 被踢回 Ready 队列，C 上台。
5. **Time 8**: C 完成。
   - B 回来继续跑剩下的 5 秒。
6. **Time 13**: B 完成。

**计算表：**

- **A**: 完成 3，到达 0 $\to T_r = 3$
- **B**: 完成 13，到达 2 $\to T_r = 11$
- **C**: 完成 8，到达 4 $\to T_r = 4$
- **平均** $T_r$ = $(3+11+4)/3 = 6$